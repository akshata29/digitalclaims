$luisAppImportUrl = $luisAuthoringEndpoint + "luis/api/v2.0/apps/import"
$outArray.Add("v_luisAppImportUrl=$luisAppImportUrl")

$luisHeader = @{
	"Ocp-Apim-Subscription-Key" = $luisAuthoringSubscriptionKey
}
$luisModels = @{ }
$luisModels.Clear()
$trainingLuisFilePath = "$ScriptRoot\luis\"

$files = Get-ChildItem $trainingLuisFilePath
foreach($file in $files){
	$fileWithExtension = $trainingLuisFilePath + $file.Name.toLower()
	$luisApplicationName = (Get-Item $fileWithExtension).Basename
	$luisApplicationFilePath = $trainingLuisFilePath + $file.Name
	$luisApplicationTemplate = Get-Content $luisApplicationFilePath
	$appVersion = '0.1'
	
	$luisAppResponse = Invoke-RestMethod -Method Post `
				-Uri $luisAppImportUrl -ContentType "application/json" `
				-Headers $luisHeader `
				-Body $luisApplicationTemplate
	$luisAppId = $luisAppResponse
	$luisModels[$luisApplicationName] = $luisAppId

	$luisTrainUrl = $luisAuthoringEndpoint + "luis/authoring/v3.0-preview/apps/" + $luisAppId + "/versions/" + $appVersion + "/train"
	
	Write-Host Training Luis Models... -ForegroundColor Green
	$luisAppTrainResponse = Invoke-RestMethod -Method Post `
				-Uri $luisTrainUrl `
				-Headers $luisHeader
	
	# Get Training Status
	# For now wait for 10 seconds
	Start-Sleep -s 10
	$luisAppTrainResponse = Invoke-RestMethod -Method Get `
				-Uri $luisTrainUrl `
				-Headers $luisHeader

	$publishJsonBody = "{
		'versionId': '$appVersion',
		'isStaging': false,
		'directVersionPublish': false
	}"

	#Publish the Model
	Write-Host Publish Luis Models... -ForegroundColor Green
	$luisPublihUrl = $luisAuthoringEndpoint + "luis/authoring/v3.0-preview/apps/" + $luisAppId + "/publish"
	$luisAppPublishResponse = Invoke-RestMethod -Method Post `
				-Uri $luisPublihUrl -ContentType "application/json" `
				-Headers $luisHeader `
				-Body $luisApplicationTemplate
	$luisAppPublishResponse
}

Default services created 
	Storage Account
	Form Recognizer
	Luis (Authoring & Prediction)
		TODO : Publishing to Prediction Resource
	Custom Vision (Training & Prediction)
	App Service Plan
	Search Service
	Cosmos Db
	Create Cosmos DB & Containers
	Upload Test/Train data to storage container
	Train LUIS model
	Web API Connection 
		Blob
		Custom Vision (Might have to do it manually for all deployment) (cognitiveservicescustomvision)
		Form Recognizer (Might have to do it manually for all deployment) (formrecognizer)
		Documentdb (accesskey not populating)
	Logic App
		There might be a need to change the web api connection for Custom Vision as well as Form Recognizer
	App Services
	Azure Bot service

	Key vault


Steps : Day 1
	* Walk through end to end demo
	* Custom Vision
		* Create a project in Custom Vision
		* Upload the images & classify the documents
		* Train the Model
		* Publish the Model (Prediction URL) (ModelName should be latest) (https://customvis478734prediction.cognitiveservices.azure.com/customvision/v3.0/Prediction/5b4c6533-835e-4248-8ff9-6393d327694a/classify/iterations/latest/url)
			* Record the ProjectId & Url
		* Test the Model in the UI
		* Show Improving the model concept via Prediction & retrain
		* Test the model using PostMan
	* Form Recognizer
		* Walk through the Form Recognizer Studio
		* Test the out of the box Models
			* Driving License
			* Invoice/Service Estimate
			* General(for Insurance)
		* Build Custom Model 
			* Create Labels & Tag
			* Train Model
			* Record ModelId
			* Test Model using UI
			* Test Model using PostMan
ModelId in Logic app
	* Logic Apps
		* Walk through the Logic app workflow
		* Modify Custom Vision ProjectId
		* Modify the custom model Id
		* Test the workflow (by uploading the document in Blob storage account)
			* For each document Type
		* Show the Debug history and execution of the workflow
		* Show the documents persisted in CosmosDb

Steps : Day 2
	* Cognitive Search
		* Concept around Cognitive Search (Data Source, Index, Indexer)
		* Execute indexer to pull data from CosmosDb	
	* Bot Framework Composer
		* Walk through the Composer and the code (including the Bot Service, Channels concepts)
		* Test the Bot using "Test in webchat"
		* Test the Bot(if possible) within Bot Framework Composer or Emulator
		* Execute the E2E workflow using HTML/Webchat
	* Show the Static Web API to display the output of the Azure search

az group create --name digitalclaims --location "West US"
az deployment group create  --name digitalclaims  --resource-group digitalclaims --template-file main.bicep --parameters prefix=aiclaims 

az login
az set subscription --name <subscriptionId>
$prefix = "aiclaims13"
az group create --name $prefix --location "East US"
az deployment sub create --location WestUS --parameters '{ "prefix": { "value": "aiclaims13" }, "location": { "value": "eastus" } }' --template-file main.bicep

-- For now manually running upload of train/test dataset till can fix the bicep deployment
$storKeys = az storage account keys list -g $prefix -n $prefix"stor" | ConvertFrom-Json
-- Execute following from deploy folder
az storage blob upload-batch -d test --account-name $prefix"stor" --source Test --account-key $storKeys[0].value
az storage blob upload-batch -d train --account-name $prefix"stor" --source Train --account-key $storKeys[0].value
-- For now manually update the prediction key & endpoint for customvision, formrecognizer & document db web connection.  web connection are created automatically otherwise
-- Possibly need to create cosmosdb web connection manually - webconnection ending with cdb